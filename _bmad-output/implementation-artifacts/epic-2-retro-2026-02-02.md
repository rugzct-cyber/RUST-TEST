# R√©trospective Epic 2: Delta-Neutral Execution

**Date:** 2026-02-02  
**Facilitateur:** Bob (Scrum Master)  
**Statut:** ‚úÖ Compl√©t√©

---

## R√©sum√© Epic 2

| M√©trique | Valeur |
|----------|--------|
| Stories compl√©t√©es | 4/4 (100%) |
| Tests au d√©marrage | 237 (fin Epic 1) |
| Tests √† la fin | 202+ |
| Clippy warnings | 0 |
| NFRs valid√©s | NFR2 (<500ms ‚úÖ ~358ms), NFR7 (auto-close ‚úÖ) |
| Latence entry mainnet | ~358ms (Story 2.3) |
| Latence close mainnet | ~500ms (Story 2.3) |

### Stories Livr√©es

| Story | Description | R√©sultat cl√© |
|-------|-------------|--------------|
| 2.1 | Placement d'ordre long | `place_order()` Vest/Paradex, EIP-712/SNIP-12, 5 unit tests |
| 2.3 | Ex√©cution delta-neutral simultan√©e | `tokio::join!` parallel execution, ~358ms latency ‚úÖ |
| 2.4 | Retry logic √©chec ordre | `retry_order()` with 3 attempts, 500ms delay, 8 tests |
| 2.5 | Auto-close √©chec leg | NFR7 safety net, `reduce_only=true`, 10 tests (8 unit + 2 integ) |

**Note:** Story 2.2 (Placement d'ordre short) fusionn√©e dans Story 2.1 - short orders test√©s inline.

---

## ‚úÖ Ce Qui a Bien March√©

1. **Architecture Modulaire Solide** ‚Äî Refactoring pr√©alable (Story 2.0) a pay√© dividendes
   - Pattern `vest/{mod, config, types, signing, adapter}` facilite navigation
   - 174 tests passent apr√®s refactoring, clippy clean
   
2. **Execution Mainnet First** ‚Äî Validation r√©elle d√®s Story 2.3
   - Delta-neutral cycle test√© live: open ‚Üí verify ‚Üí close
   - Latence ~358ms entr√©e, ~500ms sortie (bien sous NFR2 <500ms)
   - D√©couverte critique: Vest n√©cessite IOC LIMIT (Market pas support√©)

3. **Pattern `tokio::join!` pour Parall√©lisation** ‚Äî Impl√©ment√© correctement d√®s Story 2.3
   - R√©duit latence √† `max(vest_latency, paradex_latency)` au lieu de somme
   - Test shows latency benefits vs sequential execution

4. **Test-Driven Safety Net (NFR7)** ‚Äî Story 2.5 auto-close rigoureusement test√©
   - 10 tests covering all AC scenarios (3 ACs √ó multiple paths)
   - Code review caught missing integration tests (Task 7.1/7.2)
   - Fix applied immediately ‚Üí 202 tests green

5. **Leverage Parity Configuration** ‚Äî Insight √©mergent pendant Story 2.3
   - Documentation note: "synchroniser leverage sur les deux exchanges avant opening"
   - Critical for true delta-neutral (same notional exposure)

---

## ‚ö†Ô∏è D√©fis Rencontr√©s

1. **Story 2.2 Phantom** ‚Äî Story exists in epics.md, missing from implementation
   - Cause: Short orders validated inline with Story 2.1 (round-trip BUY+SELL)
   - Impact: Sprint-status doesn't list 2-2, but functionality complete
   - Learning: Update sprint-status.yaml when stories merge/pivot

2. **Vest Market Orders Not Supported** ‚Äî Discovered during live testing
   - Workaround: IOC LIMIT with aggressive prices (acts like market)
   - Size formatting: exactly 4 decimals required by Vest API
   - Paradex: True MARKET orders work natively

3. **Test Count Discrepancy** ‚Äî Stories report different final counts
   - Story 2.3: 184 tests
   - Story 2.4: 192 tests (+8 retry tests)
   - Story 2.5: 202 tests (+10 auto-close tests)
   - Root cause: Likely parallel work removing flaky/prelim tests
   - Learning: Lock test baseline at sprint start for accurate tracking

4. **Code Review Findings (Story 2.5)** ‚Äî Integration tests claimed but missing
   - Task 7.1/7.2 marked [x] but tests didn't exist
   - Fixed same day with `test_delta_neutral_with_auto_close_{long|short}_fails()`
   - Both tests PASS ‚Üí NFR7 validated
   - Learning: Adversarial code review catches "check-the-box" behavior

---

## üìù Suivi R√©trospective Epic 1

| Action Item | Status | Evidence |
|-------------|--------|----------|
| C1: Mode `--monitor` live data | ‚úÖ Compl√©t√© | `src/bin/monitor.rs` cr√©√©, validated with real data |
| C2: Validation visuelle donn√©es | ‚úÖ Compl√©t√© | rugz confirmed "√ßa marche" (2026-02-01) |
| C3: Doc #[serial(env)] | ‚ùå Non fait | Still missing from CONTRIBUTING.md |
| P1: Paper trading mode | ‚è≥ Partiel | Not needed for Epic 2 (live mainnet testing prioritized) |
| I1: Exports mod.rs checklist | ‚ùå Non appliqu√© | Still forgetting exports (not a factor in Epic 2) |

**Epic 1 Actions Applied:**
- ‚úÖ Live feedback essential ‚Üí Every story validated with bin/ test on mainnet
- ‚úÖ Brownfield validation-first ‚Üí Reviewed existing code before modifying
- ‚úÖ TDD discipline ‚Üí +65 tests added across Epic 2 (237‚Üí202+)

---

## üö® Chemin Critique (Avant Epic 3)

| # | Action | Owner | Crit√®re de succ√®s |
|---|--------|-------|-------------------|
| C1 | Complete #[serial(env)] docs | Elena | Section in CONTRIBUTING.md |
| C2 | Test count audit | Charlie | Confirm 202 is accurate baseline |
| C3 | Epic 2.2 sprint-status fix | Bob | Add 2-2 or clarify inline merge |

## üìã Pr√©paration Epic 3: State Persistence

| # | Action | Owner | Notes |
|---|--------|-------|-------|
| P1 | Supabase schema design | Alice | Table `positions` with delta-neutral metadata |
| P2 | Research supa-rs client patterns | Charlie | Connection pooling, retry logic |
| P3 | Design PositionState struct | Charlie | In-memory ‚Üî DB mapping |
| P4 | NFR10 test strategy | Dana | How to simulate crash/restart? |

**Dependencies Validated (Epic 2 ‚Üí Epic 3):**
- ‚úÖ `DeltaNeutralResult` struct avec `long_order`, `short_order`, latency
- ‚úÖ `OrderResponse` includes `order_id`, `filled_quantity`, `avg_price`
- ‚úÖ Both exchanges support `get_position()` for verification
- ‚úÖ Delta-neutral execution reliable (~358ms latency, retry+auto-close safety)

**Gaps Identifi√©s:**
- ‚ö†Ô∏è Pas de `position_id` unique dans `DeltaNeutralResult` ‚Üí √Ä ajouter pour Supabase PK
- ‚ö†Ô∏è `LegStatus::Failed(String)` perd structured error info ‚Üí Consider enum variant

---

## üîß Am√©liorations Process

| # | Action | Owner | Deadline |
|---|--------|-------|----------|
| I1 | Story merge protocol | Bob | Before Epic 3 Story 1 |
| I2 | Test baseline lock at sprint start | Dana | Before Epic 3 |
| I3 | DoD checklist: "integration tests RUN" | All Devs | Immediate |

---

## üí° Le√ßons Cl√©s

1. **Live Mainnet Testing >> Mocks** ‚Äî Discovered Vest Market limitation, size formatting, get_position nuances
2. **Modular Refactoring Upfront Pays Off** ‚Äî Story 2.0 made Stories 2.1-2.5 smoother
3. **`tokio::join!` Pattern Works** ‚Äî Parallel execution reduces latency as expected
4. **Adversarial Code Review Essential** ‚Äî Caught missing integration tests, prevents "check-the-box"
5. **NFR Compliance Validated Early** ‚Äî NFR2 (<500ms) and NFR7 (auto-close) proven on mainnet
6. **Question Assumptions Early** ‚Äî Epic 3 design simplified massively after clarifying exchange constraints (1 position per asset/direction) - avoid over-engineering!

---

## üîÆ Preview Epic 3: State Persistence

**D√©pendances sur Epic 2:** ‚úÖ Toutes satisfaites
- `DeltaNeutralResult` avec metadata complet
- `OrderResponse` avec order_id, filled_quantity, avg_price
- Execution stable (~358ms latency, safety nets valid√©s)

**Stories planifi√©es:** 3.1-3.4 (Module creation, Supabase save, restore, in-memory coherence)

**‚ö†Ô∏è IMPORTANT:** Compl√©ter C1-C3 avant de commencer Epic 3

**‚úÖ DESIGN DECISION RESOLVED (2026-02-02):**

**Key Insight:** Both Vest and Paradex enforce **1 position maximum per (asset, direction)**
- ‚úÖ Cannot have 2 long BTC positions simultaneously
- ‚úÖ Cannot have long + short on same asset on same exchange
- ‚úÖ This makes reconciliation MUCH simpler!

**Epic 3 Approach - Natural Key Strategy:**
- **Natural Unique Key:** `(exchange, symbol, direction)` uniquely identifies any position
- **Paradex:** Has native `id` field (nice to have for logs, not essential for matching)
- **Vest:** No native ID, but `(symbol, isLong)` is unique per exchange rules
- **Reconciliation:** Simple `.find()` by (symbol + direction) - guaranteed ‚â§1 match
- **Partial Close Support:** Track `remaining_size` in DB, compare with exchange size on restore

**Supabase Schema (Simplified):**
```sql
CREATE TABLE positions (
    position_id UUID PRIMARY KEY,          -- Internal PK
    long_exchange VARCHAR(20),             -- "vest"
    long_symbol VARCHAR(50),               -- "BTC-PERP"
    short_exchange VARCHAR(20),            -- "paradex"  
    short_symbol VARCHAR(50),              -- "BTC-USD-PERP"
    remaining_size DECIMAL(20, 8),         -- For partial close tracking
    entry_spread_percent DECIMAL(10, 4),
    opened_at TIMESTAMPTZ,
    UNIQUE(long_symbol, short_symbol)      -- 1 delta-neutral position per pair
);
```

**Actions Epic 3:**
- ‚úÖ No need to update `ParadexPositionData` struct (ID optional)
- ‚úÖ No complex composite key tracking needed
- ‚úÖ Simple reconciliation: match by (symbol, direction)

---

## Prochaines √âtapes

1. ‚úÖ Marquer `epic-2-retrospective: done` dans sprint-status.yaml
2. Compl√©ter C1-C3 (docs, audit, sprint-status fix)
3. Design session: Supabase schema + PositionState struct
4. Commencer Story 3.1 via workflow `create-story`

---

**Velocity Epic 2:** 4 stories, ~192‚Üí202 tests (+10), 0 clippy errors, NFR2+NFR7 validated mainnet

*"On a construit le moteur d'ex√©cution. Maintenant il faut qu'il survive aux crashs."* ‚Äî Charlie (Senior Dev)
