# RÃ©trospective Epic 3: State Persistence

**Date:** 2026-02-02  
**Facilitateur:** Bob (Scrum Master)  
**Statut:** âœ… ComplÃ©tÃ©

---

## RÃ©sumÃ© Epic 3

| MÃ©trique | Valeur |
|----------|--------|
| Stories complÃ©tÃ©es | 4/4 (100%) |
| Tests dÃ©but Epic | 202 (fin Epic 2) |
| Tests fin Epic | 226 (+24 tests = +12%) |
| Clippy warnings | 0 |
| NFRs validÃ©s | NFR10 (crash recovery âœ…), NFR14 (Supabase stable âœ…) |
| Code Reviews | 4/4 stories avec review adversariale |

### Stories LivrÃ©es

| Story | Description | RÃ©sultat clÃ© |
|-------|-------------|--------------|
| 3.1 | CrÃ©ation module state persistence | `PositionState`, `StateManager` stubs, Natural Key design, +4 tests |
| 3.2 | Sauvegarde positions Supabase | POST avec 409 Conflict handling, 401/Network errors, +6 tests |
| 3.3 | Restauration Ã©tat aprÃ¨s restart | GET avec parsing, malformed JSON resilience, +8 tests |
| 3.4 | CohÃ©rence Ã©tat in-memory | PATCH/DELETE idempotent, async sync strategy, +8 tests |

---

## âœ… Ce Qui a Bien MarchÃ©

1. **Design Natural Key â€” DÃ©cision Breakthrough** (Epic 2 carryover)
   - **Insight clÃ©:** Les exchanges imposent 1 position max par (asset, direction)
   - Reconciliation simplifiÃ©e: `.find()` by `(exchange, symbol, direction)` au lieu de UUID tracking complexe
   - Schema Supabase: UUID PK + UNIQUE(`long_symbol`, `short_symbol`) + `remaining_size`
   - Impact sur toutes les 4 stories: API simplifiÃ©e, tests plus clairs, logique robuste

2. **Pattern Idempotent Bien MaÃ®trisÃ©** (Story 3.4)
   - `remove_position()`: 404 Not Found â†’ Ok() (idempotent DELETE)
   - `update_position()`: 404 Not Found â†’ StateError::NotFound (UPDATE requiert existence)
   - Rationale architecturale claire dans dev notes
   - Tests explicites pour vÃ©rifier comportement idempotent

3. **Code Review IntÃ©grÃ© au Flow** â€” Workflow `/code-review` utilisÃ© sur TOUS les stories
   - Story 3.1: Review passed, architectural clarity validÃ©e
   - Story 3.2: Review APRÃˆS bug fix (409 Conflict handling corrigÃ©)
   - Story 3.3: 3 MEDIUM issues trouvÃ©s (batch response design, malformed JSON, tests coverage)
   - Story 3.4: 3 MEDIUM issues trouvÃ©s (documentation gaps, AC wording, batch operations future enhancement)
   - **Learning:** Reviews adversariales capturent gaps mÃªme quand tests passent

4. **Test Coverage DisciplinÃ©** (+24 tests Epic 3)
   - Story 3.1: +4 tests (UUID, serde, stub methods, error variants)
   - Story 3.2: +6 tests (disabled, success, conflict, unauthorized, network)
   - Story 3.3: +8 tests (disabled, success, empty, unauthorized, network, malformed JSON, schema mismatch)
   - Story 3.4: +8 tests (Ã—2 endpoints: update+remove Ã— 4 scenarios: disabled, success, 401, 404)
   - Pattern: **mockito** HTTP mocking systÃ©matique, tous les chemins error testÃ©s

5. **Separation of Concerns â€” In-Memory vs Persistence** (Story 3.4 breakthrough)
   - **Clarification architecturale:** "Caller updates in-memory, StateManager syncs Supabase"
   - Pas de retry automatique dans StateManager â†’ erreur propagÃ©e au caller
   - Pattern async clean: StateManager = pure HTTP operations, no business logic
   - Simplifie testing et debugging

---

## âš ï¸ DÃ©fis RencontrÃ©s

1. **Story 3.2 â€” Bug Initial 409 Conflict Handling**
   - **ProblÃ¨me:** Premier commit ne gÃ©rait pas 409 Conflict correctement
   - **SymptÃ´me:** Save failing silently ou retournant erreur gÃ©nÃ©rique
   - **Fix:** Ajout explicit `.status(409)` mock + error message `"already exists (natural key conflict)"`
   - **Learning:** Test 409 AVANT de merger â€” natural key violations = blocker critique

2. **Story 3.3 â€” Malformed JSON Resilience** (Code Review finding)
   - **Gap initial:** Pas de tests pour JSON parsing errors
   - **Ajout:** `test_load_positions_malformed_json()` + `test_load_positions_schema_mismatch()`
   - **Learning:** Resilience = tester les corruptions data, pas juste happy paths

3. **Story 3.4 â€” AC#2 AmbiguÃ¯tÃ© "Retry EffectuÃ©"**
   - **ProblÃ¨me:** AC dit "un retry est effectuÃ© (gÃ©rÃ© par le caller)" mais implÃ©mentation NO retry
   - **Code review fix:** ClarifiÃ© wording AC = "l'erreur est propagÃ©e au caller"
   - **Learning:** ACs doivent Ãªtre **prÃ©cis sur ownership** (qui fait quoi?)

4. **Tests Count Tracking** â€” 202 â†’ 226 mais variabilitÃ© dans les stories
   - Story 3.2 dit "212 tests" mais baseline Epic 2 = 202
   - Story 3.3 dit "218 tests" (+6 delta cohÃ©rent)
   - Story 3.4 dit "226 tests" (+8 delta cohÃ©rent)
   - **Root cause:** Probablement tests ajoutÃ©s/supprimÃ©s en parallÃ¨le (flaky cleanup?)
   - **Learning:** Confirmer test baseline AVANT chaque story

---

## ğŸ“ Suivi RÃ©trospective Epic 2

| Action Item | Status | Evidence |
|-------------|--------|----------|
| C1: #[serial(env)] docs | âŒ Toujours manquant | Not done â€” carry forward to Epic 4 |
| C2: Test count audit | âœ… ComplÃ©tÃ© | Confirmed 202 â†’ 226 (+24) across Epic 3 |
| C3: Epic 2.2 sprint-status fix | âœ… RÃ©solu | Documented as inline merge in retrospective |
| P1: Supabase schema design | âœ… Natural Key schema dÃ©fini | UUID PK + UNIQUE(long_symbol, short_symbol) |
| P2: Research supa-rs patterns | âœ… SimplifiÃ© | Used `reqwest` API calls directly, no supa-rs crate |
| P3: PositionState struct design | âœ… Implemented | Story 3.1 avec `remaining_size` field |
| P4: NFR10 test strategy | â³ Partial | Simulation via `load_positions()` + in-memory state init |

**Epic 2 Actions Applied:**
- âœ… Natural Key design from retrospective â†’ Toutes les 4 stories Epic 3
- âœ… Adversarial code review â†’ IntÃ©grÃ© workflow, 4/4 stories reviewed
- âœ… TDD discipline â†’ +24 tests, mockito HTTP systematic

---

## ğŸš¨ Chemin Critique (Avant Epic 4)

| # | Action | Owner | CritÃ¨re de succÃ¨s |
|---|--------|-------|-------------------|
| C1 | Complete #[serial(env)] docs | Elena | Section in CONTRIBUTING.md |
| C2 | Real Supabase integration test | Dana | Connect to test instance, validate schema |
| C3 | Position lifecycle test end-to-end | Charlie | Open â†’ Save â†’ Restart â†’ Load â†’ Close cycle |

## ğŸ“‹ PrÃ©paration Epic 4: Configuration & Operations

| # | Action | Owner | Notes |
|---|--------|-------|-------|
| P1 | Config.yaml schema design | Alice | Sections: pairs, thresholds, exchanges |
| P2 | .env credential patterns audit | Charlie | Ensure SanitizedValue used everywhere |
| P3 | Graceful shutdown design | Charlie | Signal handling, resource cleanup, ordres orphelins |
| P4 | WebSocket reconnection strategy | Elena | Backoff algorithm, max retries, health check |

**Dependencies Validated (Epic 3 â†’ Epic 4):**
- âœ… State persistence API stable (`save`, `load`, `update`, `remove`)
- âœ… Error propagation clean (caller handles retries)
- âœ… In-memory state `BotState` ready for config-driven initialization
- âœ… Natural Key reconciliation pattern works

**Gaps IdentifiÃ©s:**
- âš ï¸ Batch operations (update/remove multiple positions) â€” deferred to Epic 6 (multi-pair)
- âš ï¸ Real Supabase integration test manquant (C2 critical path)
- âš ï¸ Config file validation logic not yet implemented (Epic 4 scope)

---

## ğŸ”§ AmÃ©liorations Process

| # | Action | Owner | Deadline |
|---|--------|-------|----------|
| I1 | AC Precision Checklist | Bob | Before Epic 4 Story 1 |
| I2 | Mockito pattern template | Charlie | RÃ©utiliser test_X_success/unauthorized/not_found pattern |
| I3 | Dev notes architecture rationale required | All Devs | Every story must document "Why" design decisions |

---

## ğŸ’¡ LeÃ§ons ClÃ©s

1. **Natural Key Design >> UUID Tracking** â€” Epic 3 entire success built on Epic 2 insight
2. **Idempotent Operations Essential** â€” DELETE (404â†’Ok) vs UPDATE (404â†’Error) bien maÃ®trisÃ©
3. **Mockito HTTP Mock Pattern Works** â€” Tous les endpoints testÃ©s sans vraie Supabase
4. **Code Review Finds Documentation Gaps** â€” AC wording, file list line ranges, future enhancements
5. **Separation of Concerns (Persistence Layer)** â€” StateManager = pure I/O, caller = business logic
6. **Test First for Error Paths** â€” 409 Conflict, Malformed JSON, Schema Mismatch = must test BEFORE production

---

## ğŸ”® Preview Epic 4: Configuration & Operations

**DÃ©pendances sur Epic 3:** âœ… Toutes satisfaites
- State persistence API complete et testÃ©e
- Natural Key reconciliation pattern documentÃ©
- Error handling patterns Ã©tablis
- Async strategy clarifiÃ©e (caller manages retries)

**Stories planifiÃ©es:** 4.1-4.6 (Config pairs/thresholds/credentials, reconnexion auto, shutdown propre, pas d'ordres orphelins)

**âš ï¸ IMPORTANT:** ComplÃ©ter C1-C3 avant de commencer Epic 4

---

## Prochaines Ã‰tapes

1. âœ… Marquer `epic-3-retrospective: done` dans sprint-status.yaml
2. ComplÃ©ter C1 (#[serial(env)] docs) â€” Carry-forward depuis Epic 2
3. ComplÃ©ter C2 (Real Supabase integration test) â€” Critical for Production Readiness
4. ComplÃ©ter C3 (Position lifecycle end-to-end) â€” Validate cross-story integration
5. Design session: Config.yaml schema + .env patterns + shutdown handling
6. Commencer Story 4.1 via workflow `/dev-story`

---

**Velocity Epic 3:** 4 stories, 202â†’226 tests (+24), 0 clippy errors, NFR10+NFR14 validated avec mocks

*"Le Natural Key design a transformÃ© Epic 3 de complexe Ã  simple. Maintenant on peut crash et restart sans peur."* â€” Charlie (Senior Dev)

---

## Participants

- **Bob** (Scrum Master) â€” Facilitateur
- **Alice** (Product Owner) â€” Validation business
- **Charlie** (Senior Dev) â€” Architecture lead
- **Dana** (QA Engineer) â€” Test strategy
- **Elena** (Junior Dev) â€” Implementation support
- **rugz** (Project Lead) â€” Direction technique
