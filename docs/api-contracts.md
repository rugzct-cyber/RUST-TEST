# HFT Arbitrage Bot - API Contracts Reference

> **Auto-generated by document-project workflow**

---

## Exchange Adapter API

### ExchangeAdapter Trait

All exchange adapters implement this unified interface:

```rust
#[async_trait]
pub trait ExchangeAdapter: Send + Sync {
    /// Connect to the exchange (WebSocket + optional REST auth)
    async fn connect(&mut self) -> ExchangeResult<()>;
    
    /// Gracefully disconnect
    async fn disconnect(&mut self) -> ExchangeResult<()>;
    
    /// Subscribe to orderbook updates for a symbol
    async fn subscribe_orderbook(&mut self, symbol: &str) -> ExchangeResult<()>;
    
    /// Unsubscribe from orderbook updates
    async fn unsubscribe_orderbook(&mut self, symbol: &str) -> ExchangeResult<()>;
    
    /// Place a new order
    async fn place_order(&mut self, order: OrderRequest) -> ExchangeResult<OrderResponse>;
    
    /// Cancel an existing order
    async fn cancel_order(&mut self, order_id: &str) -> ExchangeResult<()>;
    
    /// Get current positions
    async fn get_positions(&self) -> ExchangeResult<Vec<PositionInfo>>;
    
    /// Get cached orderbook (non-blocking)
    fn get_orderbook(&self, symbol: &str) -> Option<Orderbook>;
    
    /// Check connection status
    fn is_connected(&self) -> bool;
    
    /// Get detailed connection health
    fn connection_health(&self) -> &ConnectionHealth;
    
    /// Exchange identifier
    fn exchange_name(&self) -> &'static str;
}
```

---

## Vest Exchange API

### REST Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/v2/register` | POST | Register signing key, get API key |
| `/v2/listenKey` | POST | Get WebSocket auth token |
| `/v2/order` | POST | Place order |
| `/v2/order/{id}` | DELETE | Cancel order |

### Registration Flow

```
1. Sign SignerProof with PRIMARY key (EIP-712)
   - approved_signer: signing key address
   - signer_expiry: 7 days from now (ms)
   
2. POST /v2/register
   Headers: x-rest-server: restserver{account_group}
   Body: {
     "primaryAddress": "0x...",
     "signingAddress": "0x...", 
     "signerExpiry": 1234567890000,
     "signature": "0x..."
   }
   
3. Response: { "apiKey": "..." }
```

### WebSocket Channels

**URL:** `wss://ws-{env}.hz.vestmarkets.com/ws-api?version=1.0&xwebsocketserver=restserver{group}&listenKey={key}`

| Channel | Format | Purpose |
|---------|--------|---------|
| `{SYMBOL}@depth` | Subscribe | Orderbook L2 updates |

**Subscription:**
```json
{
  "method": "SUBSCRIBE",
  "params": ["BTC-PERP@depth"],
  "id": 1
}
```

**Depth Message:**
```json
{
  "channel": "BTC-PERP@depth",
  "data": {
    "bids": [["42000.00", "1.5"], ...],
    "asks": [["42001.00", "2.0"], ...]
  }
}
```

---

## Paradex Exchange API

### REST Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/v1/system/config` | GET | Get chain ID, class hashes |
| `/v1/auth` | POST | Get JWT token |
| `/v1/orders` | POST | Place order |
| `/v1/orders/{id}` | DELETE | Cancel order |

### Authentication Flow

```
1. Fetch /v1/system/config
   → starknet_chain_id
   → paraclear_account_hash
   → paraclear_account_proxy_hash

2. Derive L2 address (if not provided)
   - Compute public key from private key
   - CREATE2-like address derivation

3. Sign auth request (SNIP-12)
   - method: "POST"
   - path: "/v1/auth"
   - body: ""
   - timestamp: seconds
   - expiration: seconds

4. POST /v1/auth
   Headers: PARADEX-STARKNET-ACCOUNT, PARADEX-STARKNET-SIGNATURE, PARADEX-TIMESTAMP, PARADEX-SIGNATURE-EXPIRATION
   
5. Response: { "jwt_token": "..." }
```

### WebSocket Protocol

**URL:** `wss://ws.api.{env}.paradex.trade/v1`

**Auth Message:**
```json
{
  "jsonrpc": "2.0",
  "method": "auth",
  "params": { "bearer": "<jwt_token>" },
  "id": 0
}
```

**Subscription:**
```json
{
  "jsonrpc": "2.0",
  "method": "subscribe",
  "params": {
    "channel": "order_book.BTC-USD-PERP.snapshot@15@100ms"
  },
  "id": 1
}
```

**Orderbook Notification:**
```json
{
  "jsonrpc": "2.0",
  "method": "subscription",
  "params": {
    "channel": "order_book.BTC-USD-PERP.snapshot@15@100ms",
    "data": {
      "market": "BTC-USD-PERP",
      "inserts": [
        { "price": "42000.00", "size": "1.5", "side": "BID" },
        { "price": "42001.00", "size": "2.0", "side": "ASK" }
      ],
      "last_updated_at": 1706000000000,
      "seq_no": 12345
    }
  }
}
```

---

## Spread Calculator API

### Core Functions

```rust
impl SpreadCalculator {
    /// Create calculator for a DEX pair
    pub fn new(dex_a: &str, dex_b: &str) -> Self;
    
    /// Calculate best spread opportunity
    /// Returns None if either orderbook is empty
    pub fn calculate(&self, ob_a: &Orderbook, ob_b: &Orderbook) -> Option<SpreadResult>;
    
    /// Entry spread: (ASK_A - BID_B) / midpoint × 100
    pub fn calculate_entry_spread(ask_a: f64, bid_b: f64) -> f64;
    
    /// Exit spread: (BID_A - ASK_B) / midpoint × 100
    pub fn calculate_exit_spread(bid_a: f64, ask_b: f64) -> f64;
    
    /// Calculate both spreads from orderbooks
    pub fn calculate_dual_spreads(&self, ob_a: &Orderbook, ob_b: &Orderbook) -> Option<(f64, f64)>;
}
```

---

## VWAP API

```rust
/// Calculate VWAP from orderbook depth
/// Returns None if insufficient depth
pub fn calculate_vwap(
    orderbook: &Orderbook,
    side: OrderSide,       // Buy = consume asks, Sell = consume bids
    target_quantity: f64,
) -> Option<VwapResult>;
```

---

## Configuration API

```rust
/// Load config from YAML file
pub fn load_config(path: &Path) -> Result<AppConfig, AppError>;

/// Load config from string (testing)
pub fn load_config_from_str(yaml: &str) -> Result<AppConfig, AppError>;

/// Validate configuration rules
impl AppConfig {
    pub fn validate(&self) -> Result<(), AppError>;
    pub fn into_shared(self) -> SharedConfig;
}
```

---

## Channel API

```rust
impl ChannelBundle {
    /// Create with specified capacity
    pub fn new(capacity: usize) -> Self;
    
    /// Subscribe to shutdown signal
    pub fn subscribe_shutdown(&self) -> broadcast::Receiver<()>;
}
```

---

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `VEST_PRIMARY_ADDR` | - | Vest primary account address |
| `VEST_PRIMARY_KEY` | - | Vest primary private key |
| `VEST_SIGNING_KEY` | - | Vest delegate signing key |
| `VEST_ACCOUNT_GROUP` | 0 | Server routing (0-9) |
| `VEST_PRODUCTION` | true | Use production endpoints |
| `PARADEX_PRIVATE_KEY` | - | Starknet private key |
| `PARADEX_ACCOUNT_ADDRESS` | - | L2 account (auto-derived if empty) |
| `PARADEX_PRODUCTION` | true | Use production endpoints |
| `RUST_LOG` | hft_bot=info | Log level filter |
| `LOG_FORMAT` | json | Output format (json/pretty) |
| `WS_HEARTBEAT_INTERVAL_SECS` | 30 | Ping interval |
| `WS_BROADCAST_CAPACITY` | 256 | Channel buffer size |
| `MAX_RETRY_ATTEMPTS` | 3 | Order retry limit |
| `ORDER_TIMEOUT_MS` | 2000 | Order timeout |
